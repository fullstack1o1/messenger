<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>messenger</title>
    <style>
        body {
            margin-left: auto;
            margin-right: auto;
            margin-bottom: auto;
            width: 40%;
            font-family: Arial, sans-serif;
        }
        #messenger {
            display: flex;
        }
        
        footer {
            margin-top: 30px;
        }
        
        footer small {
            display: block;
            text-align: right;
            color: gray;
        }

        #messenger__users {
            flex: 1.5;
            height: 500px;
            overflow-y: scroll;
        }

        #messenger__users ul {
            list-style: none;
            padding: 0;
        }

        #messenger__users ul li {
            padding: 10px;
            cursor: pointer;
            margin: 10px 10px;
        }

        #messenger__users ul li:hover {
            background-color: blue;
            color: white;
            border-radius: 5px;

        }

        .messenger__user__selected {
            background-color: blue;
            color: white;
            border-radius: 5px;
            
        }

        .messenger__user {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 10px;
            border: 1px solid #f0f0f0;
        }

        .messenger__user__profile {
            display: inline-block;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: #f0f0f0;
            text-align: center;
            line-height: 30px;
        }

        .messenger__user__name {
            display: inline-block;
        }
        
        .messenger__user__onlinestatus {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: green;
        }

        .messenger__user__unreadmessage {
            display: inline-block;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background-color: red;
            color: white;
            text-align: center;
            line-height: 20px;
            margin-right: 10px;
        }

        #messenger__chat__box {
            flex: 3;
            border-left: 1px solid gray;
        }

        #messenger__chat__box_h2 {
            margin-left: 10px;
            padding: 10px;
            background-color: blue;
            color: white;
        }

        #messenger__chat__box__input {
            display: flex;
            gap: 10px;
            padding: 10px;
        }

        #messenger__chat__box__messages {
            height: 400px;
            overflow-y: scroll;
            padding: 10px;

        }

        #messenger__chat__box__messages ul {
            list-style: none;
            padding: 0;
        }

        #messenger__chat__box__messages ul li {
            padding: 10px;
            margin: 10px;
            border-radius: 5px;
            background-color: #f0f0f0;
        }

        #messenger__chat__box__messages ul li span {
            display: block;
        }

        #messenger__chat__box__messages ul li small {
            display: block;
            color: gray;
            margin-top: 10px;
            margin-bottom: 5px;
        }

        .messenger__chat__box__message__IN {
            text-align: right;
        }

        .messenger__chat__box__message__OUT {
            text-align: left;
        }

        #new__group__form {
            padding: 10px;
        }

        #new__group__form label, #new__group__form button {
            display: block;
            margin-bottom: 10px;
        }

        #new__group__form input, #new__group__form select, #new__group__form button {
            padding: 10px;
            margin-bottom: 10px;
        }

    </style>
</head>
<body>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <div id="app">
        <h1>{{ message }}</h1>
        <div style="display: flex; justify-content: space-between;">
            <p>Welcome, {{ me?.username }}</p>
            <p style="color: blue; cursor: pointer;" @click="logout()">Logout</p>
        </div>
        <hr/>
        <p v-if="error" style="display: block; padding: 10px; background-color: red;color: #f0f0f0;">{{error}}</p>
        <div id="messenger">
            <div id="messenger__users">
                <ul>
                    <li :class=" targetUser === user ? 'messenger__user__selected messenger__user' : 'messenger__user' " v-for="user in users" @click="() => targetUser = user">
                        <span class="messenger__user__profile">&#128115;</span>
                        <span class="messenger__user__name">{{ user.username }}</span>
                        <span class="messenger__user__onlinestatus" v-if="user.online"></span>
                        <span class="messenger__user__unreadmessage" v-if="false">0</span>
                    </li>
                    <li :class="displayNewGroupForm ? 'messenger__user__selected' : ''" @click="() => displayNewGroupForm = !displayNewGroupForm">{{ displayNewGroupForm ? '- New Group' : '+ New Group'}}</li>
                    <li :class=" targetUser === group ? 'messenger__user__selected messenger__user' : 'messenger__user' " v-for="group in []" @click="() => targetUser = group">    {{ group }}</li>
                </ul>
            </div>
            <div id="messenger__chat__box">
                <new-group :users="users" v-if="displayNewGroupForm"></new-group>
                <template v-else>
                    <p style="text-align: center;" v-if="!targetUser">Select a user to chat</p>
                    <chat-box v-else @send-message="sendInstantMessage" :me="me" :target-user="targetUser"></chat-box>
                </template>
            </div>
        </div>  
        <footer>
            <hr/>
            <small>&copy; All rights reserved</small>
        </footer>
    </div>
    <template id="chatBox">
        <div >
            <h2 id="messenger__chat__box_h2">
                <span class="messenger__user__profile">&#128115;</span> 
                {{ u?.username }}
            </h2>
            <div id="messenger__chat__box__messages">
                <ul>
                    <li class="messenger__chat__box__message__OUT">
                        <small>Me:</small>
                        <span>Hi, How are you?</span>
                        <small>10:00 AM</small>
                    </li>
                    <li class="messenger__chat__box__message__IN">
                        <small>User:</small>
                        <span>Hi, How are you?</span>
                        <small>10:00 AM</small>
                    </li>
                    <li class="messenger__chat__box__message__OUT">
                        <small>Me:</small>
                        <span>Hi, How are you?</span>
                        <small>10:00 AM</small>
                    </li>
                    <li class="messenger__chat__box__message__OUT">
                        <small>Me:</small>
                        <span>Hi, Uu there?</span>
                        <small>10:00 AM</small>
                    </li>
                </ul>

            </div>
            <div id="messenger__chat__box__input">
                <form @submit.prevent="sendMessage">
                    <input type="text" placeholder="Type your message here..." style="width: 100%; padding: 10px;" v-model="message"/>
                    <button style="padding: 10px;">Send</button>
                </form>
            </div>
        </div>
    </template>
    
    <template id="newGroup">
        <form id="new__group__form" @submit.prevent="() => console.log('FORM_SUBMIT')">
            <fieldset>
                <legend>New Group Creation</legend>
                <label for="name">Name</label>
                <input type="text" id="name">
                <label for="users">Members</label>
                <select id="users" multiple>
                    <option value="" disabled>Select multiple user</option>
                    <option v-for="user in users" :value="user.id">{{ user.username }}</option>
                </select>
                <button>Create Group</button>
            </fieldset>
        </form>
    </template>
    
    <script>
    const { createApp, ref, toRef, onMounted } = Vue
    const apiHost = 'http://localhost:8080'

    const NewGroup = {
            template: '#newGroup',
            props: ['users'],
            emits: [],
            setup(props, { emit }) {
                const group = ref(null)
                const users = toRef(props, 'users')
                return {
                    group, users
                }
            }
        }
    
    const ChatBox = {
            template: '#chatBox',
            props: ['me','targetUser'],
            emits: ['sendMessage'],
            setup(props, { emit }) {
                const i = toRef(props, 'me')
                const u = toRef(props, 'targetUser')
                const message = ref('')
                
                const sendMessage = () => {
                    emit('sendMessage', {from: i.value.userId, to: u.value.userId, message: message.value})
                    message.value = ''
                }

                return {
                    i, u, message, sendMessage
                }
            }
        }

    createApp({
        setup() {
            const message = ref('Online Chat!')
            const error = ref(null)
            const targetUser = ref(null)
            const me = ref(null)
            const users = ref([])
            const displayNewGroupForm = ref(false)
            let stompClient = null;
            const whoami = () => {
                fetch(`${apiHost}/me`,{
                        method: 'GET',
                        credentials: 'include'
                })
                .then(res => {
                    if(res.ok) {
                        return res.json()
                    }
                    throw new Error('Failed to fetch')
                })
                .then(data => {
                    me.value = data
                })
                .then(() => {
                    allUsers()
                    wsConnect()
                })
                .catch(err => {
                    error.value = err.message
                })
            }

            const allUsers = () => {
                fetch(`${apiHost}/users`,{
                        method: 'GET',
                        credentials: 'include'
                })
                .then(res => {
                    if(!res.ok) {
                        throw new Error('Failed to fetch')
                    }
                    return res.json()
                })
                .then(data => {
                    users.value = data.filter(d => d.userId !== me.value.userId)
                })
                .catch(err => {
                    error.value = err.message
                })
            }

            const logout = () => {
                document.cookie = 'JSESSIONID = ; Max-Age=0; path=/;'
                window.location.href = `${apiHost}/logout`
            }

            const sendInstantMessage = (instantMessage) => {
                console.log(instantMessage)
                var instantMessageRequest = {
                    type: 'USER',
                    to: instantMessage.to,
                    content: instantMessage.message 
                }
                if (stompClient && stompClient.connected) {
                    stompClient.send('/app/private', {}, JSON.stringify(instantMessageRequest));
                } else {
                    error.value = 'Stomp client is not connected.'
                    console.error('Stomp client is not connected.');
                }
            }

            const wsConnect = () => {
                const socket = new SockJS(`${apiHost}/ws`)
                stompClient = Stomp.over(socket)
                
                stompClient.connect({}, frame => {
                    console.log('Connected: ' + frame)
                    const headers = { 'auto-delete': true, 'x-message-ttl': 6000 }
                    stompClient.subscribe('/user/queue/private', message => {
                        console.log('Received: ' + message.body)
                    }, headers)
                })
            }

            onMounted(() => {
                whoami()
            })

            return {
                message, error, targetUser, me, users, logout, displayNewGroupForm, sendInstantMessage
            }
        },
        components: { ChatBox, NewGroup }
    }).mount('#app')
    </script>
    
</body>
</html>